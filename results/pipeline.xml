<?xml version="1.0" encoding="UTF-8"?>
<xsl:transform xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
               xmlns:xs="http://www.w3.org/2001/XMLSchema"
               xmlns:hp="http://code.google.com/p/half-pipe/"
               xmlns:as="http://atomserver.org/namespaces/1.0/"
               xmlns:saxon="http://saxon.sf.net/"
               xmlns:atom="http://www.w3.org/2005/Atom"
               xmlns:c="http://www.w3.org/ns/xproc-step"
               xmlns:cx="http://xmlcalabash.com/ns/extensions"
               xmlns:os="http://a9.com/-/spec/opensearch/1.1/"
               xmlns:xproc="http://www.w3.org/ns/xproc"
               xmlns:p="http://www.w3.org/ns/xproc"
               xmlns:pxp="http://exproc.org/proposed/steps"
               xmlns:test="http://www.test.bbc.co.uk/"
               version="2.0"
               exclude-result-prefixes="xml xsl as saxon atom xs c cx hp os xproc p pxp test">
    <xsl:output indent="yes" omit-xml-declaration="no" method="xml" encoding="utf-8"
                media-type="application/xml"/>
    <xsl:strip-space elements="*"/>
    <xsl:template match="/">
        <xsl:variable name="source" select="root()" hp:input="source"/>
        <xsl:variable name="feed" as="document-node()?" hp:step="p:identity">
            <xsl:document>
                <xsl:apply-templates select="$source" mode="p:identity-feed"/>
            </xsl:document>
        </xsl:variable>
        <xsl:variable name="d1e6" as="document-node()?" hp:step="p:add-attribute">
            <xsl:document>
                <xsl:apply-templates select="$source" mode="p:add-attribute-d1e6"/>
            </xsl:document>
        </xsl:variable>
        <xsl:copy-of select="$d1e6" hp:output="result"/>
    </xsl:template>
    <xsl:template match="*" mode="p:identity-feed">
        <xsl:copy copy-namespaces="no">
            <xsl:copy-of select="@*"/>
            <xsl:apply-templates select="*|text()" mode="#current"/>
        </xsl:copy>
    </xsl:template>
    <xsl:template match="//atom:link" mode="p:add-attribute-d1e6">
        <xsl:copy copy-namespaces="no">
            <xsl:copy-of select="@*"/>
            <xsl:attribute name="href">
                <xsl:value-of select="saxon:evaluate('name()')"/>
            </xsl:attribute>
            <xsl:apply-templates select="*|text()" mode="#current"/>
        </xsl:copy>
    </xsl:template>
    <xsl:template match="*" mode="p:add-attribute-d1e6">
        <xsl:copy copy-namespaces="no">
            <xsl:copy-of select="@*"/>
            <xsl:apply-templates select="*|text()" mode="#current"/>
        </xsl:copy>
    </xsl:template>
</xsl:transform>